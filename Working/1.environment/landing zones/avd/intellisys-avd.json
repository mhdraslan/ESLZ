{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "templatesBaseUri": {
            "type": "string"
        },
        "location": {
            "type": "string"
        }
    },
    "functions": [],
    "variables": {
        //"environmentName":"cnxg-aen-avd",
        "subscriptionId":"67236ec4-f453-4086-b4d1-78a6a93fad71",
        "templatesBaseUri":"https://raw.githubusercontent.com/mhdraslan/ESLZ/main/Working/",
        "location":"eastus",
        "resourceGroupName":"cnxg-aen-avd-rg",
        "resourceGroupDeploymentName":"[concat('3-Create-ResourceGroup-',variables('resourceGroupName'))]",
        "udrDeploymentName":"[concat('3-Create-UDR-AVD')]",
        "templates":[
            {
                "resourceGroup":"[concat(variables('templatesBaseUri'),'/2.definitions/landing-zone/resourcegroup.json')]",
                "vnet":"[concat(variables('templatesBaseUri'),'/2.definitions/landing-zone/virtualnetwork.json')]",
                "subnet":"[concat(variables('templatesBaseUri'),'/2.definitions/landing-zone/subnet.json')]",
                "nsg":"[concat(variables('templatesBaseUri'),'/2.definitions/landing-zone/nsg.json')]",
                "windowsVm":"[concat(variables('templatesBaseUri'),'/2.definitions/landing-zone/vm-provisionwindowsserver.json')]",
                "udr":"[concat(variables('templatesBaseUri'),'/2.definitions/landing-zone/udr.json')]"
            }
        ],
        "resourceGroups":{
                "rgSettings":[
                    {
                        "rgName":"cnxg-aen-avd-rg",
                        "rgLocation":"uaenorth"
                    },
                    {
                        "rgName":"cnxg-aen-avd2-rg",
                        "rgLocation":"uaenorth"
                    }

                ]
        },
        "vnets":{
                "vnetSettings":[
                    {
                        "vNetName":"cnxg-aen-avd-vnet",
                        "vNetAddressSpace":"192.168.5.0/24",
                        "vNetDnsServers":["192.168.0.4","192.168.0.5"]
                    },
                    {
                        "vNetName":"cnxg-aen-avd2-vnet",
                        "vNetAddressSpace":"192.168.50.0/24",
                        "vNetDnsServers":["192.168.0.4","192.168.0.5"]
                    }
                ]
        },
        "subnets":{
            "subnetSettings":[
                {
                    "subnetName":"PrivEndpointSubnet",
                    "vNetName":"cnxg-aen-avd-vnet",
                    "subnetAddress":"192.168.5.0/28"
                },
                {
                    "subnetName":"FrontendSubnet",
                    "vNetName":"cnxg-aen-avd-vnet",
                    "subnetAddress":"192.168.5.16/28"
                },
                {
                    "subnetName":"BackendSubnet",
                    "vNetName":"cnxg-aen-avd-vnet",
                    "subnetAddress":"192.168.5.32/28"
                },
                {
                    "subnetName":"BackendSubnet",
                    "vNetName":"cnxg-aen-avd2-vnet",
                    "subnetAddress":"192.168.50.32/28"
                }
            ]
        },
        "routes":{
            "udrTables":[
                {
                    "routeTableName":"cnxg-aen-avd-rt"
                },
                {
                    "routeTableName":"cnxg-aen-avd2-rt"
                }
            ],
            "udrLinks":[
                {
                    "routeTableName":"cnxg-aen-avd-rt",
                    "vNetName":"cnxg-aen-avd-vnet",
                    "subnetName":"FrontendSubnet"
                },
                {
                    "routeTableName":"cnxg-aen-avd-rt",
                    "vNetName":"cnxg-aen-avd-vnet",
                    "subnetName":"BackendSubnet"
                },
                {
                    "routeTableName":"cnxg-aen-avd2-rt",
                    "vNetName":"cnxg-aen-avd-vnet",
                    "subnetName":"BackendSubnet"
                }
            ],
            "udrSettings":[
                {
                    "routeEntryName":"default-route",
                    "routeEntryAddressPrefix":"0.0.0.0/0",
                    "routeEntryType":"Internet",
                    "routeEntryNextHopIPAddress":"",
                    "routeTableName":"cnxg-aen-avd-rt"
                },
                {
                    "routeEntryName":"onprem-route",
                    "routeEntryAddressPrefix":"172.31.0.0/16",
                    "routeEntryType":"None",
                    "routeEntryNextHopIPAddress":"",
                    "routeTableName":"cnxg-aen-avd-rt"
                },
                {
                    "routeEntryName":"default-route",
                    "routeEntryAddressPrefix":"0.0.0.0/0",
                    "routeEntryType":"Internet",
                    "routeEntryNextHopIPAddress":"",
                    "routeTableName":"cnxg-aen-avd2-rt"
                },
                {
                    "routeEntryName":"onprem-route",
                    "routeEntryAddressPrefix":"172.31.0.0/16",
                    "routeEntryType":"None",
                    "routeEntryNextHopIPAddress":"",
                    "routeTableName":"cnxg-aen-avd2-rt"
                }
            ]
        },
        "windowsVMs":{
            "vmSettings":[
                {
                    "vmName":"aentalabatbe01",
                    "vNetName":"cnxg-aen-talabat-vnet",
                    "subnetName":"BackendSubnet",
                    "osDiskType":"StandardSSD_LRS",
                    "osVersionNumber":"2019",
                    "vmSize":"Standard_b2s",
                    "adminUsername":"localadmin",
                    "adminPassword":"dat23uPhutu*"
                },
                {
                    "vmName":"aentalabatbe02",
                    "vNetName":"cnxg-aen-talabat-vnet",
                    "subnetName":"BackendSubnet",
                    "osDiskType":"StandardSSD_LRS",
                    "osVersionNumber":"2019",
                    "vmSize":"Standard_b2s",
                    "adminUsername":"localadmin",
                    "adminPassword":"dat23uPhutu*"
                },
                {
                    "vmName":"aentalabatfe01",
                    "vNetName":"cnxg-aen-talabat-vnet",
                    "subnetName":"FrontendSubnet",
                    "osDiskType":"StandardSSD_LRS",
                    "osVersionNumber":"2019",
                    "vmSize":"Standard_b2s",
                    "adminUsername":"localadmin",
                    "adminPassword":"dat23uPhutu*"
                },
                {
                    "vmName":"aentalabatfe02",
                    "vNetName":"cnxg-aen-talabat-vnet",
                    "subnetName":"FrontendSubnet",
                    "osDiskType":"StandardSSD_LRS",
                    "osVersionNumber":"2019",
                    "vmSize":"Standard_b2s",
                    "adminUsername":"localadmin",
                    "adminPassword":"dat23uPhutu*"
                }
            ]
        }

    },
    "resources": [
        {
            "type":"Microsoft.Resources/deployments",
            "apiVersion":"2019-05-01",
            "Name":"3-Create-AVD-ResourceGroups",
            "location":"[variables('location')]",
            "properties":{
                "mode":"Incremental",
                "templatelink":{
                    "uri":"[variables('templates')[0].resourceGroup]"
                },
                "parameters":{
                    "subscriptionId":{
                        "value":"[variables('subscriptionId')]"
                    },
                    "templatesBaseUri":{
                        "value":"[parameters('templatesBaseUri')]"
                    },
                    "location":{
                        "value":"[parameters('location')]"
                    },
                    "lzName":{
                        "value":"AVD"
                    },
                    "resourceGroups":{
                        "value":"[variables('resourceGroups')]"
                    }
                }
            }
        },
        {
            "type":"Microsoft.Resources/deployments",
            "apiVersion":"2019-05-01",
            "Name":"['3-Create-AVD-VirtualNetworks']",
            "dependsOn": [
                "3-Create-AVD-ResourceGroups"
            ],
            "location": "[parameters('location')]",
            "properties":{
                "mode":"Incremental",
                "templatelink":{
                    "uri":"[variables('templates')[0].vnet]"
                },
                "parameters":{
                    "subscriptionId":{
                        "value":"[variables('subscriptionId')]"
                    },
                    "resourceGroup":{
                        "value":"[variables('resourceGroupName')]"
                    },
                    "templatesBaseUri":{
                        "value":"[parameters('templatesBaseUri')]"
                    },
                    "lzName":{
                        "value":"AVD"
                    },
                    "vNets":{
                        "value":"[variables('vnets')]"
                    },
                    "subnets":{
                        "value":"[variables('subnets')]"
                    },
                    "routes":{
                        "value":"[variables('routes')]"
                    }
                }
            }
        }/*,
        {
            "type":"Microsoft.Resources/deployments",
            "apiVersion":"2019-05-01",
            "Name":"[concat('3-Create-WindowsVM-',variables('windowsVMs')[copyIndex()].vmName)]",
            "dependsOn": ["SubnetsCopy"],
            "resourceGroup": "[variables('resourceGroupName')]",
            "copy": {
                "name": "WindowsVirtualMachinesCopy",
                "count": "[length(variables('windowsVMs'))]"
            },
            "properties":{
                "mode":"Incremental",
                "templatelink":{
                    "uri":"[variables('templates')[0].windowsVm]"
                },
                "parameters":{
                    "vmName":{
                        "value":"[variables('windowsVMs')[copyIndex()].vmName]"
                    },
                    "vNetName":{
                        "value":"[variables('windowsVMs')[copyIndex()].vNetName]"
                    },
                    "subnetName":{
                        "value":"[variables('windowsVMs')[copyIndex()].subnetName]"
                    },
                    "osDiskType":{
                        "value":"[variables('windowsVMs')[copyIndex()].osDiskType]"
                    },
                    "osVersionNumber":{
                        "value":"[variables('windowsVMs')[copyIndex()].osVersionNumber]"
                    },
                    "vmSize":{
                        "value":"[variables('windowsVMs')[copyIndex()].vmSize]"
                    },                                        
                    "adminUsername":{
                        "value":"[variables('windowsVMs')[copyIndex()].adminUsername]"
                    },
                    "adminPassword":{
                        "value":"[variables('windowsVMs')[copyIndex()].adminPassword]"
                    }
                }
            }
        },
        {
            "type":"Microsoft.Resources/deployments",
            "apiVersion":"2019-05-01",
            "Name":"[variables('udrDeploymentName')]",
            "dependsOn": ["[variables('resourceGroupDeploymentName')]"],
            "resourceGroup": "[variables('resourceGroupName')]",
            "properties":{
                "mode":"Incremental",
                "templatelink":{
                    "uri":"[variables('templates')[0].udr]"
                },
                "parameters":{
                    "environmentName":{
                        "value":"[parameters('environmentName')]"
                    },
                    "templatesBaseUri":{
                        "value":"[parameters('templatesBaseUri')]"
                    },
                    "RouteEntryAddressPrefix":{
                        "value":"[parameters('appGwTier')]"
                    },
                    "routeEntryType":{
                        "value":"[parameters('appGwPrivateIpAddress')]"
                    },
                    "routeEntryNextHopIPAddress":{
                        "value":"[parameters('publicIpAddressSku')]"
                    }
                }
            }
        }*/
    ],
    "outputs": {}
}
